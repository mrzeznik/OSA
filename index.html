<!DOCTYPE html>
<html>

<head>
  <title>OSA</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      font-family: Consolas, "Courier New", monospace;
    }

    input,
    textarea {
      border: 2px solid;
      border-radius: 4px;
    }

    .container {
      min-height: 10em;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>OSA</h1>
    <h4>Osobisty System Atencji</h4>
    <label for="notificationText">Text:</label><br>
    <textarea id="notificationText" name="notificationText" rows="12" cols="50"
      placeholder="Your notification text..."></textarea><br><br>
    <label for="interval">Interval (min):</label>
    <input type="number" id="interval" name="interval" min="1" max="10080" value="1" maxlength="5" size="6"><br><br>
    <input type="submit" onclick="startNotificatons();" value="Run">
  </div>
  <script>
    const notificationTitle = 'OSA';
    const baseMinuteMultiplier = 1000 * 60;
    const notificationElement = document.getElementById('notificationText');
    const intervalElement = document.getElementById('interval');
    var timers = [];
    var delayed = [];

    function startNotificatons() {
      Notification.requestPermission().then(function (permission) {
        console.log('Notification permission: ' + permission);
      });

      removeNotifications();

      let interval = intervalElement.value;
      let bodyBase = notificationElement.value
        .split('\n')
        .map(function (line) { return line.trim(); })
        .filter(function (line) { return line !== undefined & line?.length > 0; }) || [];

      setMultipleNotifications(bodyBase, interval);
    }

    function setMultipleNotifications(notifications, interval) {
      if (interval < 1) return;

      let notificationCount = notifications.length;
      let notificationInterval = interval * notificationCount * baseMinuteMultiplier;
      notifications.forEach((notificationText, notificationNumber) => {
        let notificationDelay = notificationNumber * notificationInterval;
        console.info('Add notification #' + parseInt(notificationNumber + 1) + ': "' + notificationText + '", every: ' + notificationInterval + ' ms, initial delay: ' + notificationDelay + ' ms');

        let delay = setTimeout(function () {
          var timer = setInterval(notify, notificationInterval, notificationTitle, notificationText);
          timers.push(timer);
        }, notificationDelay);
        delayed.push(delay);
      });
    }

    function notify(title, body) {
      var notification = new Notification(title, { body });
    }

    function removeNotifications() {
      console.log("Removing existing notifications.");
      timers.forEach(function (timer) {
        clearInterval(timer);
      });
      timers = [];
      delayed.forEach(function (delay) {
        clearTimeout(delay);
      });
      delayed = [];
    }
  </script>
</body>

</html>